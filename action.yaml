name: "Verify uv build"
description: "Verify the uv build artifacts"

author: "Thibaut Durand"

branding:
  icon: "check-circle"
  color: "blue"

inputs:
  package-name:
    description: "The package name"
    required: true
  package-extra:
    description: "The package extra to install"
    required: false
    default: ""
  package-dependencies:
    description: |
      "A list of dependencies to check in the build in the format
      <dependency1> <dependency2> <dependency3> ..."
    required: false
    default: ""
  dist-type:
    description: "The distribution artifact. Choose either wheel or sdist"
    required: false
    default: "wheel"
  python-version:
    description: "Python version to use"
    required: false
    default: "3.13"
  skip-py-typed-check:
    description: "Skip the py.typed marker check"
    required: false
    default: "false"

runs:
  using: "composite"
  steps:
    # Step 1: Validate dist-type input
    - name: Verify dist-type
      shell: bash
      run: |
        set -euo pipefail
        if [[ "${{ inputs.dist-type }}" != "wheel" && "${{ inputs.dist-type }}" != "sdist" ]]; then
          echo "âŒ Error: input 'dist-type' must be 'wheel' or 'sdist'."
          exit 1
        fi
        echo "âœ… Distribution type: ${{ inputs.dist-type }}"

    # Step 2: Install uv package manager
    - name: Install uv
      uses: astral-sh/setup-uv@v7
      with:
        python-version: ${{ inputs.python-version }}
        activate-environment: true

    # Step 3: Build the package
    - name: Build package
      shell: bash
      run: |
        set -euo pipefail
        echo "ğŸ“¦ Building package..."
        uv build
        echo "âœ… Build completed"

    # Step 4: Locate the target distribution file
    - name: Locate target distribution
      shell: bash
      id: dist
      run: |
        set -euo pipefail
        if [ "${{ inputs.dist-type }}" = "wheel" ]; then
          EXTENSION="whl"
        else
          EXTENSION="tar.gz"
        fi
        TARGET=$(ls dist/*."$EXTENSION" | head -n1)

        if [ -z "$TARGET" ]; then
          echo "âŒ Error: No ${{ inputs.dist-type }} distribution found"
          exit 1
        fi

        echo "ğŸ“„ Found distribution: $TARGET"
        echo "target=$TARGET" >> "$GITHUB_OUTPUT"

    # Step 5: Verify py.typed marker exists
    - name: Check py.typed in distribution
      shell: bash
      if: inputs.skip-py-typed-check != 'true'
      run: |
        set -euo pipefail
        if [ "${{ inputs.dist-type }}" = "wheel" ]; then
          TOOL="unzip -l"
        else
          TOOL="tar -tzf"
        fi

        if $TOOL "${{ steps.dist.outputs.target }}" | grep -q py.typed; then
          echo "âœ… py.typed marker found"
        else
          echo "âš ï¸  Warning: py.typed marker not found"
          exit 1
        fi

    # Step 6: Install the built package
    - name: Install built package
      shell: bash
      run: |
        set -euo pipefail
        PKG="${{ steps.dist.outputs.target }}"
        if [ -n "${{ inputs.package-extra }}" ]; then
          PKG="${PKG}[${{ inputs.package-extra }}]"
          echo "ğŸ“¦ Installing package with extra: ${{ inputs.package-extra }}"
        else
          echo "ğŸ“¦ Installing package..."
        fi
        uv pip install "$PKG"
        echo "âœ… Package installed successfully"

    # Step 7: Validate package metadata with twine
    - name: Install and run twine check
      shell: bash
      run: |
        set -euo pipefail
        if uv pip install twine 2>/dev/null; then
          echo "ğŸ” Running twine check..."
          twine check dist/*
          echo "âœ… Twine check passed"
        else
          echo "âš ï¸  Twine not available, skipping metadata validation"
        fi

    # Step 8: Run custom metadata checks (optional)
    - name: Check package metadata
      shell: bash
      if: hashFiles('dev/package/check_metadata.sh') != ''
      run: |
        set -euo pipefail
        echo "ğŸ” Running custom metadata checks..."
        bash dev/package/check_metadata.sh
        echo "âœ… Metadata checks passed"

    # Step 9: Verify dependency tree (optional)
    - name: Check dependency tree
      shell: bash
      run: |
        set -euo pipefail
        echo "ğŸ” Checking dependency tree..."
        bash scripts/check_dependency_tree.sh ${{ inputs.package-name }} ${{ inputs.package-dependencies }}
        echo "âœ… Dependency tree checks passed"

    # Step 10: Test package import and version
    - name: Verify package import and version
      shell: bash
      run: |
        set -euo pipefail
        echo "ğŸ” Testing package import..."

        VERSION=$(python -c "import ${{ inputs.package-name }}; print(${{ inputs.package-name }}.__version__)")
        echo "ğŸ“Œ Package version: $VERSION"

        if [ "$VERSION" = "0.0.0" ]; then
          echo "âŒ Error: Package version is placeholder '0.0.0'"
          exit 1
        fi

        echo "âœ… Package imported successfully with valid version"

    # Step 11: Validate type hints (optional)
    - name: Check package type hints
      shell: bash
      if: hashFiles('dev/package/check_type.sh') != ''
      run: |
        set -euo pipefail
        if uv pip install pyright 2>/dev/null; then
          echo "ğŸ” Running type hint validation..."
          bash dev/package/check_type.sh
          echo "âœ… Type hints validated"
        else
          echo "âš ï¸  Pyright not available, skipping type check"
        fi

    # Step 12: Run custom checks (optional)
    - name: Run custom checks
      shell: bash
      if: hashFiles('dev/package/custom_checks.sh') != ''
      run: |
        set -euo pipefail
        echo "ğŸ” Running custom checks..."
        bash dev/package/custom_checks.sh
        echo "âœ… Custom checks passed"
