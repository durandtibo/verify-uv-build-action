name: Test Local Action

on:
  workflow_call:
  workflow_dispatch: # to trigger manually

permissions:
  actions: write
  contents: read

jobs:
  test:
    runs-on: ${{ matrix.os }}
    timeout-minutes: 10
    strategy:
      max-parallel: 8
      fail-fast: false
      matrix:
        os: [ubuntu-24.04]
        dist-type: ["sdist", "wheel"]
        extra: ["", "all"]

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Verify Build
        uses: ./
        with:
          dist-type: ${{ matrix.dist-type }}
          package-name: myproject
          package-extra: ${{ matrix.package-extra }}

  invalid-dist-type:
    name: Invalid dist-type
    runs-on: ubuntu-24.04
    continue-on-error: true
    outputs:
      failed: ${{ steps.run_action.outcome }}
    steps:
      - name: Call composite action with invalid value
        id: run_action
        uses: ./
        with:
          dist-type: tar

  verify-failure-dist-type:
    name: Verify failure for invalid dist-type
    runs-on: ubuntu-24.04
    needs: invalid-dist-type
    if: ${{ needs.invalid-dist-type.outputs.failed != 'failure' }}
    steps:
      - run: |
          echo "‚ùå The action did NOT fail when it should have."
          exit 1
